<div id="vm__vmID">
    Clinical trial visit 1 data entry
    <ul>
        <li><u q="ESS Form ^ P1 V1">ESS</u></li>
        <li><u q="EQ-5D-5L Form ^ P1 V1">EQ-5D-5L</u></li>
    </ul>
</div>
<script>
    (function(){
        //---------------------------
        var dd=[];
        //---------------------------
        var us=document.getElementById("vm__vmID").querySelectorAll('u');
        us.forEach(el => {
            dd.push({name:el.getAttribute('q'),value:0});
            el.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                var q=el.getAttribute('q');
                if(el.style && el.style.color=='lightgreen') alert('Already answered')
                else $vm.query(q);
            });
        });
        //---------------------------
        I=0;
        var process=function(){
            I++;
            if(I==dd.length){
                console.log(dd);
                for(var i=0;i<dd.length;i++){
                    if(dd[i].value==1){
                        us[i].style.color='lightgreen';
                    }
                }                
            }
        }
        //---------------------------
        var ask_server_to_check=function(i){
            setTimeout(() => {
                var req={cmd:"json-data-check", q:dd[i].name, field:"id", value:uid}
                $vm.request(req).then((res)=>{
                    if(res.status=="ok" && res.result==1){
                        dd[i].value=1;
                    }
                    process();
                });
            }, 10+i*200);
        }
        //---------------------------
        var uid=$vm.params["uid"];
        if(uid){
            for(var i=0;i<dd.length;i++){
                ask_server_to_check(i);
            }
        }
        //---------------------------
    })();
</script>